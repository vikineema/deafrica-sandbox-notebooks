# This workflow publishes the deafrica-tools to TestPyPi.

# The name of your workflow. GitHub displays the names of your workflows on your repository's actions page. 
name: Publish deafrica-tools to TestPyPI
# Defines which events can cause the workflow to run. 
on:
  # Triggers the workflow to run  1) when a push that includes a change to any file in the Tools/ directory and/or a change to this workflow file is made to the publish-deafrica-tools branch or 2) when a release has been published or 3) by clicking the 'Run workflow' button on the Actions tab.
  push:
    branches:
      - publish-deafrica-tools
    paths:
      - 'Tools/**'
      - '.github/workflows/publish.yml'
  release:
    types: [published]
  workflow_dispatch:

# A workflow run is made up of one or more jobs, which run in parallel by default.
# This workflow contains a single job called "Publish".
jobs:
  # Job unique identifier.
  build-n-publish:
    # Name for the job, which is displayed on GitHub.
    name: Build and publish deafrica-tools to TestPyPI
    # Specifies the runner environment the 'publish' job will run in.
    runs-on: ubuntu-latest
    # A job contains a sequence of tasks called steps.
    steps:
      # The uses keyword specifies that this step will run v2 of the actions/checkout action. This is an action that checks out your repository onto the runner, allowing you to run scripts or other actions against your code (such as build and test tools). You should use the checkout action any time your workflow will run against the repository's code. $GITHUB_WORKSPACE, so your job can access it.
      - uses: actions/checkout@v2

      - name: Get history and tags for SCM versioning to work
        run: |
          git fetch --prune --unshallow
          git fetch --depth=1 upstream +refs/tags/*:refs/tags/*
          git describe --tags
          git describe --tags $(git rev-list --tags --max-count=1)

      - name: Build deafrica-tools
        run: |
            python3 -m pip install setuptools_scm build
            python3 -m setuptools_scm
            cd Tools
            python3 -m pip install --upgrade pip
            python3 -m pip install --use-feature=in-tree-build --no-deps .
            python3 -c "import deafrica_tools; print(deafrica_tools.__version__)"
            python3 -m build
            
      - name: Publish distribution to Test PyPI
        # You may pin to the exact commit or the version.
        # uses: pypa/gh-action-pypi-publish@27b31702a0e7fc50959f5ad993c78deac1bdfc29
        uses: pypa/gh-action-pypi-publish@v1.4.2
        with:
          # Test PyPI user
          user: ${{ secrets.TEST_PYPI_USER }}
          # Password for your Test PyPI user or an access token
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository_url: https://test.pypi.org/legacy/
          # The target directory for distribution
          packages_dir: Tools/dist
          # Check metadata before uploading
          verify_metadata: true
          # Do not fail if a Python package distribution exists in the target package index
          skip_existing: false
          # Show verbose output.
          verbose: true
          
